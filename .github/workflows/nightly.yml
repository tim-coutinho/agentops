name: Nightly

on:
  schedule:
    - cron: '0 6 * * *'  # 6am UTC daily
  workflow_dispatch:  # Allow manual trigger

permissions:
  issues: write
  contents: read

jobs:
  cli-tests:
    name: Go CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.26'
          cache-dependency-path: cli/go.sum

      - name: Run CLI tests with coverage
        working-directory: cli
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic ./... -v
          echo ""
          echo "=== Coverage Summary ==="
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}')
          echo "Total coverage: $COVERAGE"
          echo "COVERAGE=$COVERAGE" >> "$GITHUB_ENV"

      - name: Test CLI builds
        working-directory: cli
        run: make build

  static-validation:
    name: Static Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Run validation
        run: |
          chmod +x tests/marketplace-e2e-test.sh
          ./tests/marketplace-e2e-test.sh --verbose

  security-toolchain:
    name: Security Toolchain
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.26'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install scanner tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install semgrep
          GOBIN=/usr/local/bin go install github.com/securego/gosec/v2/cmd/gosec@latest
          GOBIN=/usr/local/bin go install github.com/zricethezav/gitleaks/v8@latest

      - name: Run security gate (full)
        run: |
          chmod +x scripts/security-gate.sh
          ./scripts/security-gate.sh --mode full

      - name: Upload security gate artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: nightly-security-gate
          path: .agents/security/
          retention-days: 7

  summary:
    name: Summary
    needs: [cli-tests, static-validation, security-toolchain]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Summary
        run: |
          echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CLI tests | ${{ needs.cli-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static validation | ${{ needs.static-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security toolchain | ${{ needs.security-toolchain.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: needs.cli-tests.result == 'failure' || needs.static-validation.result == 'failure' || needs.security-toolchain.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="Nightly build failed: $(date -u +%Y-%m-%d)"
          BODY="## Nightly Build Failure

          | Job | Status |
          |-----|--------|
          | CLI tests | ${{ needs.cli-tests.result }} |
          | Static validation | ${{ needs.static-validation.result }} |
          | Security toolchain | ${{ needs.security-toolchain.result }} |

          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please investigate and fix before the next release."

          # Check if issue already exists for today
          EXISTING=$(gh issue list --label "nightly-failure" --search "$TITLE" --state open --json number --jq '.[0].number' 2>/dev/null || true)
          if [[ -z "$EXISTING" ]]; then
            gh issue create --title "$TITLE" --body "$BODY" --label "bug,nightly-failure"
          else
            echo "Issue #$EXISTING already exists for today's failure"
          fi

      - name: Check for failures
        if: needs.cli-tests.result == 'failure' || needs.static-validation.result == 'failure' || needs.security-toolchain.result == 'failure'
        run: exit 1
